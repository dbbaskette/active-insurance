spring:
  application:
    name: sense-processor

  # Import external configuration (vars.yaml for local development)
  config:
    import: optional:file:./vars.yaml

  # Jackson JSON configuration
  jackson:
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false

  # RabbitMQ defaults (overridden by vars.yaml or CF service binding)
  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}

  # Spring Cloud Stream configuration (pattern matches imc-telemetry-processor)
  cloud:
    function:
      definition: sense
    stream:
      bindings:
        # Input: Telemetry from imc-telematics-gen (telematics_exchange)
        sense-in-0:
          destination: ${TELEMETRY_INPUT_EXCHANGE:telematics_exchange}
          group: ${TELEMETRY_INPUT_GROUP:sense-processor}
          consumer:
            concurrency: 3

        # Output 0: Vehicle events -> JDBC consumer -> Greenplum (for ML)
        sense-out-0:
          destination: ${VEHICLE_EVENTS_OUTPUT_EXCHANGE:vehicle_events}
          content-type: application/json

        # Output 1: Behavior context -> Coach Agent
        sense-out-1:
          destination: ${BEHAVIOR_CONTEXT_OUTPUT_EXCHANGE:behavior_context_exchange}
          content-type: application/json

      rabbit:
        bindings:
          sense-in-0:
            consumer:
              exchangeType: ${TELEMETRY_INPUT_EXCHANGE_TYPE:fanout}
              auto-bind-dlq: true
              durable-subscription: true
              max-attempts: 3
          sense-out-0:
            producer:
              exchangeType: topic
              requiredGroups: ${VEHICLE_EVENTS_OUTPUT_GROUP:vehicle-events-group}
          sense-out-1:
            producer:
              exchangeType: topic
              requiredGroups: ${BEHAVIOR_CONTEXT_OUTPUT_GROUP:behavior-context-group}

# Spring AI Configuration (values from vars.yaml or environment)
spring.ai:
  openai:
    api-key: ${spring.ai.openai.api-key:}
    chat:
      options:
        model: ${spring.ai.openai.chat.options.model:gpt-5-nano}
        temperature: ${spring.ai.openai.chat.options.temperature:1}

# Sense component detection thresholds
sense:
  detection:
    accident:
      g-force-threshold: 5.0
    harsh-braking:
      g-force-threshold: 0.4
      duration-ms: 500
    speeding:
      tolerance-mph: 5
      sustained-seconds: 10
    cornering:
      lateral-g-threshold: 0.3
    drift:
      yaw-rate-threshold: 15

  # AI-powered intent classification settings
  ai:
    intent-classification:
      # Enable/disable LLM-based intent classification
      enabled: ${SENSE_AI_INTENT_CLASSIFICATION_ENABLED:true}
      # Only invoke AI for behaviors above these thresholds (be selective!)
      # Harsh braking: detected at 0.4g, but only AI classify if > 1.5g (high severity)
      g-force-threshold: 1.5
      # Speed excess: only AI classify if > 25 mph over limit (significant)
      speed-excess-threshold: 25
      # Cornering: detected at 0.3g, only AI classify if lateral g > 0.6
      lateral-g-threshold: 0.6

  window:
    time-duration: 30s
    event-count: 50
    overlap-ratio: 0.5

  session:
    timeout: 5m
    max-active: 10000

# Actuator endpoints for observability
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    tags:
      application: ${spring.application.name}

# Logging
logging:
  level:
    com.insurancemegacorp.sense: INFO
    org.springframework.cloud.stream: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# Server configuration
server:
  port: 8081

---
# Cloud profile for Cloud Foundry deployment
spring:
  config:
    activate:
      on-profile: cloud

logging:
  level:
    com.insurancemegacorp.sense: INFO
